name: Documentation

on:
  push:
    branches: [main, master]
    paths:
      - '**.rs'
      - '**/Cargo.toml'
      - '**.md'
      - '.github/workflows/docs.yml'
  pull_request:
    paths:
      - '**.rs'
      - '**/Cargo.toml'
      - '**.md'
      - '.github/workflows/docs.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  docs:
    name: Documentation Build & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rust-docs

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-

      - name: Build documentation
        run: cargo doc --no-deps --all-features

      - name: Check documentation for broken internal links
        run: |
          # Check for broken internal links using cargo-deadlinks if installed
          if cargo install --list | grep -q cargo-deadlinks; then
            cargo deadlinks --dir target/doc
          else
            echo "cargo-deadlinks not installed, skipping broken link check"
          fi

      - name: Run documentation tests
        run: cargo test --doc --all-features

      - name: Check for broken external links (optional, using HTMLproofer-style check)
        run: |
          # Basic check for common issues in generated docs
          # This is a lightweight check - for full link checking, consider lychee
          if command -v lychee &> /dev/null; then
            lychee --config .lychee.toml --markdown --verbose target/doc/**/*.html 2>/dev/null || true
          else
            echo "lychee not installed, skipping external link check"
            echo "To enable external link checking: cargo install lychee"
          fi

  docs-rs-compatibility:
    name: docs.rs Build Compatibility
    runs-on: ubuntu-latest

    # Only run on main/master pushes and PRs, not on every commit
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check docs.rs build compatibility
        run: |
          # Build docs as if for docs.rs (without network access to simulate their build environment)
          cargo doc --no-deps --all-features --lib

          # Check that documentation builds without warnings
          RUSTDOCFLAGS="--cap-lints warn" cargo doc --no-deps --all-features --lib 2>&1 | \
            grep -q "warning:" && echo "WARNINGS_FOUND=true" || echo "WARNINGS_FOUND=false"

          # docs.rs uses --document-private-items to document private items too
          cargo doc --no-deps --all-features --lib --document-private-items

  doc-coverage:
    name: Documentation Coverage
    runs-on: ubuntu-latest
    needs: docs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Generate coverage report
        run: |
          # Check if we have doctest files
          echo "=== Documentation Test Summary ==="
          cargo test --doc --all-features -- --list 2>/dev/null | wc -l | xargs echo "Number of doc tests:"
          cargo test --doc --all-features 2>&1 | tail -20
